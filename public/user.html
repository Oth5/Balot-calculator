<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>لوحة المستخدم</title>
    <link rel="stylesheet" href="./style/style1.css" />
    <style>
      .wrap {
        max-width: 900px;
        margin: 24px auto;
        padding: 0 12px;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        margin: 12px 0;
      }
      .table {
        width: 100%;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
      }
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }
      thead th {
        background: #f9fafb;
        padding: 10px;
        text-align: center;
      }
      tbody td {
        padding: 10px;
        text-align: center;
        border-top: 1px solid #e5e7eb;
      }
      .btn {
        height: 36px;
        padding: 0 14px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #fff;
        cursor: pointer;
        font-weight: 600;
      }
      .btn.primary {
        background: #2563eb;
        color: #fff;
        border-color: #2563eb;
      }
      a {
        color: black;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div class="header">لوحة المستخدم</div>
    <div class="wrap">
      <div class="toolbar">
        <button class="btn primary" id="newGame">إنشاء جلسة جديدة</button>
        <button class="btn" id="refresh">تحديث</button>
        <button class="btn" id="logout">
          <a href="login.html">تسجيل خروج</a>
        </button>
      </div>

      <div class="table">
        <table>
          <thead>
            <tr>
              <th>رقم الجلسة</th>
              <th>الحالة</th>
              <th>وقت البداية</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="gamesTable">
            <tr>
              <!--يعبئ ديناميكيا-->>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      const API_URL = window.location.hostname.includes("localhost")
        ? "http://localhost:3000" // لو تشغل محلي
        : "https://balot-calculator-production.up.railway.app"; // لو على Railway

      function readId() {
        const id = new URLSearchParams(location.search).get("users_id");
        return id;
      }

      async function loadgames() {
        const tbody = document.getElementById("gamesTable");
        const id = readId();

        tbody.innerHTML = "<tr><td colspan='4'>جار التحميل...</td></tr>";

        try {
          const d = await axios.get(`${API_URL}/users/${id}/games`);
          const result = d.data;
          if (result.length === 0) {
            tbody.innerHTML = "<tr><td colspan='4'>لايوجد جلسات</td></tr>";
            return;
          }

          const games = Array.isArray(result) ? result : [result];

          const newtable = games
            .map(
              (e) =>
                `
            <tr>
          <td>${e.id}</td>
                    <td>${e.status}</td>
             <td>${
               e.start_time
                 ? new Date(e.start_time).toLocaleString("ar-EG", {
                     hour: "2-digit",
                     minute: "2-digit",
                     month: "long",
                     day: "2-digit",
                   })
                 : "-"
                }</td>
     <td><button onclick="GoPlay(${e.id})">الانتقال الى اللعب </button></td>
                </tr>`
            
            )
            .join("");
            tbody.innerHTML=newtable;
        } catch (e) {
          alert("خطأ في جلب القيم");
          console.error(e, e.messege);
        }
      }
      document.getElementById("refresh").addEventListener("click", loadgames);

      async function creategames() {
        const id = readId();

        try {
          const d = await axios.post(`${API_URL}/games`, { users_id: id });
          result = d.data;
          await loadgames();
          alert("تم اضافه صكه");
          GoPlay(d.data.game.id);
        } catch (e) {
          console.error(e, e.code, e.messege);
          alert("خطا في اضافه صكه جديده");
        }
      }
      document.getElementById("newGame").addEventListener("click", creategames);
      loadgames();

      async function GoPlay(id) {
        try {
          const d = await axios.get(`${API_URL}/games/${id}`);
          if (d.data.status === "finished") {
            alert("الصكه منتهيه ماتقدر توصل لها");
            return;
          }

          window.location.href = `userpage.html?game_id=${encodeURIComponent(id)}`;
        } catch (e) {
          alert("مشكله في الانتقال");
          console.error(e.code, e);
        }
      }
    </script>
  </body>
</html>

<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>لوحة المستخدم</title>
    <link rel="stylesheet" href="./style/style1.css" />
    <style>
      .wrap {
        max-width: 900px;
        margin: 24px auto;
        padding: 0 12px;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        margin: 12px 0;
      }
      .table {
        width: 100%;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
      }
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }
      thead th {
        background: #f9fafb;
        padding: 10px;
        text-align: center;
      }
      tbody td {
        padding: 10px;
        text-align: center;
        border-top: 1px solid #e5e7eb;
      }
      .btn {
        height: 36px;
        padding: 0 14px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #fff;
        cursor: pointer;
        font-weight: 600;
      }
      .btn.primary {
        background: #2563eb;
        color: #fff;
        border-color: #2563eb;
      }
      a {
        color: black;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div class="header">لوحة المستخدم</div>
    <div class="wrap">
      <div class="toolbar">
        <button class="btn primary" id="newGame">إنشاء جلسة جديدة</button>
        <button class="btn" id="refresh">تحديث</button>
        <button class="btn" id="logout">
          <a href="login.html">تسجيل خروج</a>
        </button>
      </div>

      <div class="table">
        <table>
          <thead>
            <tr>
              <th>رقم الجلسة</th>
              <th>الحالة</th>
              <th>وقت البداية</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="gamesTable">
            <tr>
              <!--يعبئ ديناميكيا-->>
            </tr>
          </tbody>
        </table>
      </div>
    </div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const API_URL = window.location.hostname.includes("localhost")
    ? "http://localhost:3000"
    : "https://balot-calculator-production.up.railway.app";

  const token = localStorage.getItem("authToken");
  if (!token) {
    window.location.href = "login.html";
  } else {
    axios.defaults.headers.common["Authorization"] = `Bearer ${token}`;

  }

  async function loadGames() {
    const tbody = document.getElementById("gamesTable");
    tbody.innerHTML = "<tr><td colspan='4'>جارِ التحميل...</td></tr>";

    try {
      // ✅ بدون users_id من الرابط — السيرفر يعرف المستخدم من التوكن
      const { data: games } = await axios.get(`${API_URL}/me/games`);

      if (!Array.isArray(games) || games.length === 0) {
        tbody.innerHTML = "<tr><td colspan='4'>لا يوجد جلسات</td></tr>";
        return;
      }

      const rows = games.map(g => `
        <tr>
          <td>${g.id}</td>
          <td>${g.status}</td>
          <td>${
            g.start_time
              ? new Date(g.start_time).toLocaleString("ar-EG", {
                  hour: "2-digit",
                  minute: "2-digit",
                  month: "long",
                  day: "2-digit",
                })
              : "-"
          }</td>
          <td><button class="btn" onclick="goPlay()">الانتقال إلى اللعب</button></td>
        </tr>
      `).join("");

      tbody.innerHTML = rows;
    } catch (e) {
      console.error(e?.response?.data || e);
      tbody.innerHTML = "<tr><td colspan='4'>تعذر جلب الجلسات</td></tr>";
      if (e?.response?.status === 401) window.location.href = "login.html";
    }
  }

  async function createGame() {
    try {
      try{
  await axios.patch(`${API_URL}/games`, { status: "finished" });
} catch (err) {
      const code = err?.response?.status;
      if (code && code !== 404) throw err; 
}

      const { data } = await axios.post(`${API_URL}/games`, {});
      const newId = data?.game?.id;
      if (!newId) throw new Error("No game id returned");
      alert("تم إنشاء جلسة جديدة ✅");
      window.location.href = `userpage.html`;
    } catch (e) {
      console.error(e?.response?.data || e);
      alert("خطأ في إنشاء جلسة جديدة");
    }
  }

  async function goPlay() {
    try {
      const { data } = await axios.get(`${API_URL}/me/games/`,{});
      if (data.status === "finished") {
        alert("الصكة منتهية ولا يمكن اللعب عليها");
        return;
      }
      window.location.href = `userpage.html`;
    } catch (e) {
      console.error(e?.response?.data || e);
      alert("مشكلة في الانتقال");
    }
  }

  function logout() {
    localStorage.removeItem("authToken");
    localStorage.removeItem("authUser");
    delete axios.defaults.headers.common["Authorization"];
    window.location.href = "login.html";
  }

  document.getElementById("refresh").addEventListener("click", loadGames);
  document.getElementById("newGame").addEventListener("click", createGame);
  document.getElementById("logout").addEventListener("click",logout);

  loadGames();

 
</script>

  </body>
</html>
